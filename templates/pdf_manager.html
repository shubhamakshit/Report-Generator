{% extends "base.html" %}

{% block title %}PDF Manager - DocuPDF{% endblock %}

{% block styles %}
<style>
    .filename-col {
        max-width: 250px;
        white-space: normal;
        word-wrap: break-word;
    }
    .folder-row, .pdf-row {
        cursor: pointer;
    }
    #folder-tree-move .list-group-item {
        cursor: pointer;
    }
    #folder-tree-move .list-group-item.active {
        background-color: #0d6efd;
        border-color: #0d6efd;
    }
    .editable-input {
        width: 100%;
        background-color: #343a40;
        color: #fff;
        border: 1px solid #0d6efd;
        border-radius: .25rem;
        padding: .375rem .75rem;
    }
</style>
{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1>PDF Manager</h1>
        <div>
            {% if all_view %}
            <a href="/pdf_manager" class="btn btn-info">Show Folders</a>
        {% else %}
            <a href="/pdf_manager?view=all" class="btn btn-info">Show All PDFs</a>
        {% endif %}
            <button class="btn btn-primary" id="create-folder-btn">Create New Folder</button>
            <a href="/upload_final_pdf" class="btn btn-success">Upload Final PDF</a>
            <a href="/" class="btn btn-primary">New Upload</a>
        </div>
    </div>

    {% if not all_view %}
    <!-- Breadcrumbs -->
    <nav aria-label="breadcrumb">
        <ol class="breadcrumb">
            <li class="breadcrumb-item"><a href="/pdf_manager">Home</a></li>
            {% for item in breadcrumbs %}
            <li class="breadcrumb-item"><a href="/pdf_manager/browse/{{ item.path }}">{{ item.name }}</a></li>
            {% endfor %}
        </ol>
    </nav>
    {% endif %}

    <!-- Bulk Actions -->
    <div class="d-flex justify-content-end align-items-center mb-3">
        <button class="btn btn-info me-2" id="bulk-persist-btn" disabled>Toggle Persist</button>
        <button class="btn btn-success me-2" id="bulk-download-btn" disabled>Download Selected</button>
        <button class="btn btn-warning me-2" id="bulk-move-btn" disabled>Move Selected</button>
        <button class="btn btn-primary me-2" id="bulk-rename-btn" disabled>Rename</button>
        <button class="btn btn-danger" id="bulk-delete-btn" disabled>Delete Selected</button>
    </div>

    <div class="card bg-dark text-white mb-4">
        <div class="card-header">
            <h2 class="h4 mb-0">Files</h2>
        </div>
        <div class="card-body">
            <div class="table-responsive">
                <table class="table table-dark table-hover" id="file-manager-table">
                    <thead>
                        <tr>
                            <th><input type="checkbox" id="select-all-checkbox"></th>
                            <th>Name</th>
                            <th>Subject</th>
                            <th>Tags</th>
                            <th>Created At</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% if not all_view %}
                        <!-- Folders -->
                        {% for folder in subfolders %}
                        <tr class="folder-row" data-path="{{ (breadcrumbs|map(attribute='path')|list)|last if breadcrumbs else '' }}/{{ folder.name }}">
                            <td><input type="checkbox" class="item-checkbox" data-item-type="folder" value="{{ folder.id }}"></td>
                            <td class="editable" data-item-type="folder" data-item-id="{{ folder.id }}" data-current-name="{{ folder.name }}"><i class="bi bi-folder-fill"></i> {{ folder.name }}</td>
                            <td></td>
                            <td></td>
                            <td>{{ folder.created_at }}</td>
                        </tr>
                        {% endfor %}
                        {% endif %}
                        
                        <!-- PDFs -->
                        {% for pdf in pdfs %}
                        <tr class="pdf-row">
                            <td><input type="checkbox" class="item-checkbox" data-item-type="pdf" value="{{ pdf.id }}"></td>
                            <td class="filename-col">
                                {% if pdf.persist %}<i class="bi bi-pin-angle-fill"></i>{% endif %}
                                <a href="/view_pdf/{{ pdf.filename }}" target="_blank">{{ pdf.filename }}</a>
                            </td>
                            <td class="editable" data-item-type="pdf" data-item-id="{{ pdf.id }}" data-current-name="{{ pdf.subject }}">{{ pdf.subject }}</td>
                            <td>{{ pdf.tags }}</td>
                            <td>{{ pdf.created_at }}</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<!-- Modals -->
<!-- ... (Create Folder and Move Modals remain the same) ... -->

{% endblock %}

{% block scripts %}
<script>
    const currentFolderId = {{ current_folder_id|tojson }};
    const folderTree = {{ folder_tree|tojson }};

    // ... (Existing script for modals and folder tree remains the same) ...

    // --- NEW SCRIPT FOR INLINE EDIT AND BULK ACTIONS ---
    document.addEventListener('DOMContentLoaded', () => {
        const bulkRenameBtn = document.getElementById('bulk-rename-btn');
        const bulkDeleteBtn = document.getElementById('bulk-delete-btn');
        const selectAllCheckbox = document.getElementById('select-all-checkbox');
        const itemCheckboxes = document.querySelectorAll('.item-checkbox');

        function getSelectedItems() {
            return Array.from(itemCheckboxes).filter(cb => cb.checked);
        }

        function updateBulkButtons() {
            const selectedItems = getSelectedItems();
            const selectedCount = selectedItems.length;
            
            // Standard bulk buttons
            document.getElementById('bulk-persist-btn').disabled = selectedCount === 0;
            document.getElementById('bulk-download-btn').disabled = selectedCount === 0 || selectedItems.some(cb => cb.dataset.itemType === 'folder');
            document.getElementById('bulk-move-btn').disabled = selectedCount === 0;
            bulkDeleteBtn.disabled = selectedCount === 0;

            // Rename button logic
            bulkRenameBtn.disabled = selectedCount !== 1;
        }

        selectAllCheckbox.addEventListener('change', e => {
            itemCheckboxes.forEach(cb => cb.checked = e.target.checked);
            updateBulkButtons();
        });

        itemCheckboxes.forEach(cb => {
            cb.addEventListener('change', updateBulkButtons);
        });

        document.querySelectorAll('.folder-row').forEach(row => {
            row.addEventListener('click', e => {
                if (e.target.matches('input[type="checkbox"]')) {
                    return;
                }
                if (e.target.closest('.dropdown')) {
                    return;
                }
                if (e.target.closest('td.editable')) {
                    window.location.href = `/pdf_manager/browse/${row.dataset.path}`;
                } else {
                    const checkbox = row.querySelector('.item-checkbox');
                    checkbox.checked = !checkbox.checked;
                    const changeEvent = new Event('change');
                    checkbox.dispatchEvent(changeEvent);
                }
            });
        });

        document.querySelectorAll('.pdf-row').forEach(row => {
            row.addEventListener('click', e => {
                if (e.target.tagName === 'A' || e.target.closest('.dropdown') || e.target.matches('input[type="checkbox"]')) {
                    return;
                }
                const checkbox = row.querySelector('.item-checkbox');
                checkbox.checked = !checkbox.checked;
                const changeEvent = new Event('change');
                checkbox.dispatchEvent(changeEvent);
            });
        });

        // --- Inline Rename Logic ---
        bulkRenameBtn.addEventListener('click', () => {
            const selectedItems = getSelectedItems();
            if (selectedItems.length !== 1) return;

            const checkbox = selectedItems[0];
            const cellToEdit = document.querySelector(`.editable[data-item-id='${checkbox.value}'][data-item-type='${checkbox.dataset.itemType}']`);
            
            if (cellToEdit) {
                const currentName = cellToEdit.dataset.currentName;
                cellToEdit.innerHTML = `<input type="text" class="editable-input" value="${currentName}" />`;
                const input = cellToEdit.querySelector('input');
                input.focus();
                input.select();

                const saveChanges = async () => {
                    const newName = input.value;
                    if (newName && newName !== currentName) {
                        const response = await fetch('/rename_item', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                item_type: checkbox.dataset.itemType,
                                item_id: checkbox.value,
                                new_name: newName
                            })
                        });
                        if (response.ok) {
                            location.reload();
                        } else {
                            alert('Failed to rename.');
                            cellToEdit.innerHTML = currentName; // Revert on failure
                        }
                    } else {
                        cellToEdit.innerHTML = currentName; // Revert if no change
                    }
                };

                input.addEventListener('blur', saveChanges);
                input.addEventListener('keydown', e => {
                    if (e.key === 'Enter') saveChanges();
                    if (e.key === 'Escape') cellToEdit.innerHTML = currentName;
                });
            }
        });

        // --- Bulk Delete Logic ---
        bulkDeleteBtn.addEventListener('click', async () => {
            const selectedItems = getSelectedItems();
            if (selectedItems.length === 0) return;

            if (!confirm(`Are you sure you want to delete ${selectedItems.length} selected item(s)? This cannot be undone.`)) {
                return;
            }

            const foldersToDelete = selectedItems.filter(cb => cb.dataset.itemType === 'folder').map(cb => cb.value);
            const pdfsToDelete = selectedItems.filter(cb => cb.dataset.itemType === 'pdf').map(cb => cb.value);

            let allSucceeded = true;

            if (foldersToDelete.length > 0) {
                for (const folderId of foldersToDelete) {
                    const response = await fetch(`/delete_folder/${folderId}`, { method: 'DELETE' });
                    if (!response.ok) allSucceeded = false;
                }
            }

            if (pdfsToDelete.length > 0) {
                const response = await fetch('/bulk_delete_pdfs', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ ids: pdfsToDelete })
                });
                if (!response.ok) allSucceeded = false;
            }

            if (allSucceeded) {
                location.reload();
            } else {
                alert('An error occurred during deletion. Some items may not have been deleted.');
            }
        });

        updateBulkButtons(); // Initial check
    });

    // ... (The rest of the existing script for modals, etc.)
</script>
{% endblock %}
