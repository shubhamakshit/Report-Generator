<!doctype html>
<html lang="en" data-bs-theme="dark">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Adjust Image</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body {
            background-color: #212529;
            overscroll-behavior: contain; /* Prevents page scroll while dragging on touch devices */
        }
        .card {
            border: 1px solid #495057;
        }
        #crop-wrapper {
            display: flex;
            justify-content: center;
            align-items: center;
            background-color: #181a1c;
            padding: 1rem;
            border-radius: .5rem;
            overflow: hidden;
            touch-action: none; /* Important for touch events */
        }
        #crop-container {
            position: relative;
            max-width: 100%;
            line-height: 0;
        }
        #crop-image {
            max-width: 100%;
            height: auto;
            display: block;
        }
        #boundary-canvas {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
        }
        .crop-point {
            position: absolute;
            transform: translate(-50%, -50%);
            cursor: move;
            z-index: 10;
        }
        .corner-point {
            width: 28px; /* Slightly larger for easier touch */
            height: 28px;
            background-color: #0d6efd;
            border: 3px solid white;
            border-radius: 50%;
            box-shadow: 0 0 15px rgba(13, 110, 253, 0.7);
        }
        .edge-point {
            width: 22px; /* Slightly larger for easier touch */
            height: 22px;
            background-color: white;
            border: 2px solid #0d6efd;
            border-radius: 4px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.3);
        }
        /* Magnifying Loupe */
        #loupe {
            display: none;
            position: absolute;
            width: 120px;
            height: 120px;
            border-radius: 50%;
            border: 4px solid #0d6efd;
            overflow: hidden;
            pointer-events: none;
            z-index: 20;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.5);
        }
        #loupe-img {
            position: absolute;
            width: 0;
            height: 0;
        }
        #loupe-crosshair {
            position: absolute;
            top: 50%;
            left: 50%;
            width: 100%;
            height: 100%;
            transform: translate(-50%, -50%);
            background-image:
                    linear-gradient(rgba(255, 255, 255, 0.3) 1px, transparent 1px),
                    linear-gradient(90deg, rgba(255, 255, 255, 0.3) 1px, transparent 1px);
            background-size: 20px 20px;
        }
        #loupe-crosshair::before, #loupe-crosshair::after {
            content: '';
            position: absolute;
            background-color: #ffc107;
        }
        #loupe-crosshair::before { left: 50%; width: 2px; height: 100%; transform: translateX(-50%); }
        #loupe-crosshair::after { top: 50%; height: 2px; width: 100%; transform: translateY(-50%); }
    </style>
</head>
<body>
<div class="container-fluid my-4">
    <div class="card bg-dark text-white">
        <div class="card-header">
            <h2 class="mb-0">Step 2: Adjust Image Boundaries</h2>
            <p class="text-white-50 mb-0">Drag the corner (●) and edge (■) points to precisely select the document.</p>
        </div>
        <div class="card-body">
            <div class="row">
                <div class="col-lg-9">
                    <div id="crop-wrapper">
                        <div id="crop-container">
                            <img id="crop-image" src="/image/upload/{{ image_info.filename }}" alt="Image to crop">
                            <canvas id="boundary-canvas"></canvas>
                            <div id="loupe"><img id="loupe-img" src="/image/upload/{{ image_info.filename }}"><div id="loupe-crosshair"></div></div>
                        </div>
                    </div>
                </div>
                <div class="col-lg-3 mt-4 mt-lg-0">
                    <h4>Image Enhancement</h4>
                    <div class="mb-3">
                        <label for="brightness" class="form-label">Brightness</label>
                        <input type="range" class="form-range" min="-100" max="100" value="0" id="brightness">
                    </div>
                    <div class="mb-3">
                        <label for="contrast" class="form-label">Contrast</label>
                        <input type="range" class="form-range" min="0.5" max="2.0" step="0.05" value="1.0" id="contrast">
                    </div>
                    <div class="mb-3">
                        <label for="gamma" class="form-label">Gamma</label>
                        <input type="range" class="form-range" min="0.2" max="2.2" step="0.1" value="1.0" id="gamma">
                    </div>
                    <hr>
                    <button id="process-btn" class="btn btn-primary w-100 mb-2">Save and Next</button>
                    <button id="skip-btn" class="btn btn-secondary w-100">Skip to Next</button>
                </div>
            </div>
            <div id="status" class="mt-3"></div>
        </div>
    </div>
</div>

<script>
    // --- DOM Elements & State ---
    const container = document.getElementById('crop-container');
    const image = document.getElementById('crop-image');
    const canvas = document.getElementById('boundary-canvas');
    const ctx = canvas.getContext('2d');
    const loupe = document.getElementById('loupe');
    const loupeImg = document.getElementById('loupe-img');
    const sessionId = '{{ session_id }}';
    const imageIndex = parseInt('{{ image_index }}');
    const points = [];
    const LOUPE_ZOOM = 2.5;

    // --- Drawing and UI Functions ---
    function drawBoundary() {
        if (points.length !== 8) return;
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        ctx.strokeStyle = 'rgba(13, 110, 253, 0.9)';
        ctx.fillStyle = 'rgba(13, 110, 253, 0.15)';
        ctx.lineWidth = 3;
        const [tl, tm, tr, ml, mr, bl, bm, br] = points.map(p => ({ x: p.x * image.width, y: p.y * image.height }));
        ctx.beginPath();
        ctx.moveTo(tl.x, tl.y);
        ctx.lineTo(tm.x, tm.y);
        ctx.lineTo(tr.x, tr.y);
        ctx.lineTo(mr.x, mr.y);
        ctx.lineTo(br.x, br.y);
        ctx.lineTo(bm.x, bm.y);
        ctx.lineTo(bl.x, bl.y);
        ctx.lineTo(ml.x, ml.y);
        ctx.closePath();
        ctx.stroke();
        ctx.fill();
    }

    function updateLoupe(clientX, clientY) {
        const rect = container.getBoundingClientRect();
        const mouseX = clientX - rect.left;
        const mouseY = clientY - rect.top;
        loupe.style.left = `${mouseX - 60}px`;
        loupe.style.top = `${mouseY - 150}px`;
        const imgX = (mouseX / image.width) * loupeImg.width;
        const imgY = (mouseY / image.height) * loupeImg.height;
        loupeImg.style.left = `-${imgX - loupe.clientWidth / 2}px`;
        loupeImg.style.top = `-${imgY - loupe.clientHeight / 2}px`;
    }

    // --- Drag Handling (for both Mouse and Touch) ---
    function startDrag(pointObj) {
        loupe.style.display = 'block';

        function onDragMove(e) {
            e.preventDefault(); // Prevent scrolling on touch
            const { clientX, clientY } = e.touches ? e.touches[0] : e;
            const rect = container.getBoundingClientRect();
            let newX = clientX - rect.left;
            let newY = clientY - rect.top;
            pointObj.x = Math.max(0, Math.min(newX / image.width, 1));
            pointObj.y = Math.max(0, Math.min(newY / image.height, 1));
            pointObj.el.style.left = `${pointObj.x * 100}%`;
            pointObj.el.style.top = `${pointObj.y * 100}%`;
            drawBoundary();
            updateLoupe(clientX, clientY);
        }

        function onDragEnd() {
            loupe.style.display = 'none';
            document.removeEventListener('mousemove', onDragMove);
            document.removeEventListener('mouseup', onDragEnd);
            document.removeEventListener('touchmove', onDragMove);
            document.removeEventListener('touchend', onDragEnd);
        }

        document.addEventListener('mousemove', onDragMove);
        document.addEventListener('mouseup', onDragEnd);
        document.addEventListener('touchmove', onDragMove, { passive: false });
        document.addEventListener('touchend', onDragEnd);
    }

    // --- Setup ---
    function setupPoints() {
        container.querySelectorAll('.crop-point').forEach(p => p.remove());
        points.length = 0;
        canvas.width = image.clientWidth;
        canvas.height = image.clientHeight;
        loupeImg.style.width = `${image.clientWidth * LOUPE_ZOOM}px`;
        loupeImg.style.height = `${image.clientHeight * LOUPE_ZOOM}px`;

        const initialLayout = [
            { x: 0.1, y: 0.1, type: 'corner' }, { x: 0.5, y: 0.1, type: 'edge' }, { x: 0.9, y: 0.1, type: 'corner' },
            { x: 0.1, y: 0.5, type: 'edge' },   { x: 0.9, y: 0.5, type: 'edge' },
            { x: 0.1, y: 0.9, type: 'corner' }, { x: 0.5, y: 0.9, type: 'edge' }, { x: 0.9, y: 0.9, type: 'corner' }
        ];

        initialLayout.forEach(pos => {
            const pointEl = document.createElement('div');
            pointEl.className = `crop-point ${pos.type}-point`;
            container.appendChild(pointEl);

            const pointObj = { el: pointEl, x: pos.x, y: pos.y, type: pos.type };
            points.push(pointObj);

            pointEl.addEventListener('mousedown', (e) => { e.preventDefault(); startDrag(pointObj); });
            pointEl.addEventListener('touchstart', (e) => { e.preventDefault(); startDrag(pointObj); });
        });
        updateAllPointPositions();
    }

    function updateAllPointPositions() {
        points.forEach(p => {
            p.el.style.left = `${p.x * 100}%`;
            p.el.style.top = `${p.y * 100}%`;
        });
        drawBoundary();
    }

    image.onload = setupPoints;
    if (image.complete) setupPoints();
    window.addEventListener('resize', () => {
        setTimeout(() => {
            if (!image.complete) return;
            canvas.width = image.clientWidth;
            canvas.height = image.clientHeight;
            loupeImg.style.width = `${image.clientWidth * LOUPE_ZOOM}px`;
            loupeImg.style.height = `${image.clientHeight * LOUPE_ZOOM}px`;
            updateAllPointPositions();
        }, 100);
    });

    // --- Form Submission ---
    document.getElementById('process-btn').addEventListener('click', async () => {
        const statusDiv = document.getElementById('status');
        statusDiv.innerHTML = `<div class="alert alert-info">Processing...</div>`;
        const corners = points.filter(p => p.type === 'corner').map(p => ({ x: p.x, y: p.y }));
        const edges = points.filter(p => p.type === 'edge').map(p => ({ x: p.x, y: p.y }));
        const pointsToSend = [...corners, ...edges];

        const adjustments = {
            brightness: parseFloat(document.getElementById('brightness').value),
            contrast: parseFloat(document.getElementById('contrast').value),
            gamma: parseFloat(document.getElementById('gamma').value)
        };

        try {
            const response = await fetch('/process_crop', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ session_id: sessionId, image_index: imageIndex, points: pointsToSend, adjustments: adjustments })
            });
            const result = await response.json();

            if (result.error) {
                statusDiv.innerHTML = `<div class="alert alert-danger">${result.error}</div>`;
            } else {
                statusDiv.innerHTML = `<div class="alert alert-success">Image processed!</div>`;
                fetch(`/crop/${sessionId}/${imageIndex + 1}`).then(res => {
                    window.location.href = res.ok ? `/crop/${sessionId}/${imageIndex + 1}` : `/question_entry/${sessionId}`;
                });
            }
        } catch (error) {
            statusDiv.innerHTML = `<div class="alert alert-danger">An error occurred: ${error}</div>`;
        }
    });

    document.getElementById('skip-btn').addEventListener('click', () => {
        fetch(`/crop/${sessionId}/${imageIndex + 1}`).then(res => {
            window.location.href = res.ok ? `/crop/${sessionId}/${imageIndex + 1}` : `/question_entry/${sessionId}`;
        });
    });
</script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>