
<!doctype html>
<html lang="en" data-bs-theme="dark">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Enter Question Details</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .keyboard-hint {
            font-size: 0.8em;
            color: #6c757d;
            margin-top: 2px;
        }
        .mobile-hint {
            font-size: 0.8em;
            color: #6c757d;
            margin-top: 2px;
        }
        .focus-visible {
            outline: 2px solid #0d6efd !important;
            outline-offset: 2px;
        }
        .sr-only {
            position: absolute;
            width: 1px;
            height: 1px;
            padding: 0;
            margin: -1px;
            overflow: hidden;
            clip: rect(0, 0, 0, 0);
            white-space: nowrap;
            border: 0;
        }
        
        /* Mobile-specific styles */
        @media (max-width: 768px) {
            .keyboard-hint {
                display: none;
            }
            .mobile-hint {
                display: block;
            }
            .btn-group-mobile {
                display: flex;
                gap: 0.5rem;
                margin-top: 0.5rem;
            }
            .btn-group-mobile .btn {
                flex: 1;
                font-size: 0.875rem;
                padding: 0.375rem 0.5rem;
            }
            .quick-actions {
                position: sticky;
                top: 10px;
                z-index: 1000;
                background: rgba(33, 37, 41, 0.95);
                backdrop-filter: blur(10px);
                border-radius: 0.5rem;
                padding: 0.5rem;
                margin-bottom: 1rem;
            }
            .form-control, .form-select {
                font-size: 16px; /* Prevents zoom on iOS */
            }
        }
        
        @media (min-width: 769px) {
            .mobile-hint {
                display: none;
            }
            .btn-group-mobile {
                display: none;
            }
            .quick-actions {
                display: none;
            }
        }
        
        .status-buttons {
            display: flex;
            gap: 0.25rem;
            margin-top: 0.25rem;
        }
        
        .status-btn {
            flex: 1;
            font-size: 0.75rem;
            padding: 0.25rem 0.5rem;
            border: 1px solid #495057;
            background: transparent;
            color: #fff;
            border-radius: 0.25rem;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .status-btn.active {
            background: #0d6efd;
            border-color: #0d6efd;
        }
        
        .status-btn:hover {
            background: #495057;
        }
        
        .floating-submit {
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 1000;
            border-radius: 50px;
            padding: 12px 24px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        }
        
        @media (min-width: 769px) {
            .floating-submit {
                display: none;
            }
        }
    </style>
</head>
<body>
    <div class="container mt-3">
        <!-- Skip to main content link -->
        <a href="#main-content" class="sr-only sr-only-focusable btn btn-primary">Skip to main content</a>
        
        <!-- Mobile Quick Actions Bar -->
        <div class="quick-actions d-md-none">
            <div class="d-flex justify-content-between align-items-center">
                <small class="text-muted">Quick Actions</small>
                <div class="btn-group-mobile">
                    <button type="button" class="btn btn-sm btn-outline-primary" id="mobile-same-subject">
                        Same Subject
                    </button>
                    <button type="button" class="btn btn-sm btn-outline-success" id="mobile-all-correct">
                        All Correct
                    </button>
                    <button type="button" class="btn btn-sm btn-outline-danger" id="mobile-all-wrong">
                        All Wrong
                    </button>
                </div>
            </div>
        </div>
        
        <div class="card bg-dark text-white">
            <div class="card-header">
                <h1 id="main-heading" class="h3">Step 3: Enter Question Details</h1>
                <div class="keyboard-hint">
                    Shortcuts: Tab to navigate | Shift+Q for Next Question | Shift+C (Correct) | Shift+W (Wrong) | Shift+U (Unattempted)
                </div>
                <div class="mobile-hint">
                    Touch to focus fields. Use quick actions above for faster input.
                </div>
            </div>
            <div class="card-body" id="main-content">
                <fieldset class="mb-4">
                    <legend class="h5">Upload Answer Key (Optional)</legend>
                    <div class="mb-3">
                        <label for="json-upload" class="form-label">Upload a JSON file with answers to auto-fill the "Correct Answer" fields.</label>
                        <input class="form-control" type="file" id="json-upload" accept=".json" aria-describedby="json-upload-help">
                        <div id="json-upload-help" class="form-text">Format: {"data": [{"question_number": "101", "answer": "A"}, ...]}</div>
                    </div>
                </fieldset>

                <form id="questions-form" role="form" aria-labelledby="main-heading">
                    <!-- Same Subject Toggle -->
                    <fieldset class="mb-4">
                        <legend class="sr-only">Global Settings</legend>
                        <div class="form-check form-switch">
                            <input 
                                class="form-check-input" 
                                type="checkbox" 
                                role="switch" 
                                id="same-subject-toggle"
                                aria-describedby="same-subject-help"
                            >
                            <label class="form-check-label" for="same-subject-toggle">
                                Same Subject for All
                            </label>
                            <div id="same-subject-help" class="mobile-hint">
                                When enabled, all questions will use the same subject as the first question
                            </div>
                        </div>
                    </fieldset>

                    {% for image in images %}
                    <fieldset class="row mb-4 border-bottom pb-3" data-question-index="{{ loop.index0 }}" id="question-fieldset-{{ image.id }}" aria-labelledby="question-{{ loop.index0 }}-heading">
                        <legend id="question-{{ loop.index0 }}-heading" class="h5 col-12 mb-3">
                            Question {{ loop.index }} - {{ image.original_name }}
                            <button type="button" class="btn btn-sm btn-outline-danger float-end delete-question-btn" data-image-id="{{ image.id }}" data-index="{{ loop.index0 }}">
                                <i class="bi bi-trash"></i> Delete
                            </button>
                        </legend>
                        
                        <div class="col-md-3 mb-3">
                            <img 
                                src="/image/processed/{{ image.processed_filename or image.filename }}" 
                                class="img-fluid rounded"
                                alt="Question {{ loop.index }} image: {{ image.original_name }}"
                                role="img"
                                style="cursor: pointer;"
                                onclick="this.requestFullscreen && this.requestFullscreen()"
                                title="Tap to view fullscreen"
                            >
                            <div class="mobile-hint text-center mt-1">Tap image to enlarge</div>
                        </div>
                        
                        <div class="col-md-9">
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label class="form-label" for="question_number_{{ loop.index0 }}">
                                        Question Number <span aria-hidden="true">*</span>
                                    </label>
                                    <input 
                                        type="number" 
                                        class="form-control" 
                                        id="question_number_{{ loop.index0 }}"
                                        name="question_number_{{ loop.index0 }}" 
                                        required
                                        aria-required="true"
                                        min="1"
                                        inputmode="numeric"
                                        pattern="[0-9]*"
                                    >
                                </div>
                                
                                <div class="col-md-6 mb-3">
                                    <label class="form-label" for="subject_{{ loop.index0 }}">Subject</label>
                                    <input 
                                        type="text" 
                                        class="form-control subject-input" 
                                        id="subject_{{ loop.index0 }}"
                                        name="subject_{{ loop.index0 }}" 
                                        data-index="{{ loop.index0 }}"
                                        autocomplete="off"
                                        list="subject-suggestions"
                                    >
                                    <!-- Subject suggestions datalist -->
                                    <datalist id="subject-suggestions">
                                        <option value="Mathematics">
                                        <option value="Physics">
                                        <option value="Chemistry">
                                        <option value="Biology">
                                        <option value="English">
                                        <option value="History">
                                        <option value="Geography">
                                    </datalist>
                                </div>
                                
                                <div class="col-md-6 mb-3">
                                    <label class="form-label" for="marked_solution_{{ loop.index0 }}">Your Answer</label>
                                    <input 
                                        type="text" 
                                        class="form-control" 
                                        id="marked_solution_{{ loop.index0 }}"
                                        name="marked_solution_{{ loop.index0 }}"
                                        autocomplete="off"
                                        list="answer-suggestions"
                                    >
                                    <datalist id="answer-suggestions">
                                        <option value="A">
                                        <option value="B">
                                        <option value="C">
                                        <option value="D">
                                        <option value="E">
                                    </datalist>
                                </div>
                                
                                <div class="col-md-6 mb-3">
                                    <label class="form-label" for="actual_solution_{{ loop.index0 }}">Correct Answer</label>
                                    <input 
                                        type="text" 
                                        class="form-control" 
                                        id="actual_solution_{{ loop.index0 }}"
                                        name="actual_solution_{{ loop.index0 }}"
                                        autocomplete="off"
                                        list="answer-suggestions"
                                    >
                                </div>
                                
                                <div class="col-md-6 mb-3">
                                    <label class="form-label" for="status_{{ loop.index0 }}">Status</label>
                                    <select 
                                        class="form-select d-none" 
                                        id="status_{{ loop.index0 }}"
                                        name="status_{{ loop.index0 }}"
                                    >
                                        <option value="correct">Correct</option>
                                        <option value="wrong">Wrong</option>
                                        <option value="unattempted">Unattempted</option>
                                    </select>
                                    
                                    <!-- Mobile-friendly status buttons -->
                                    <div class="status-buttons" data-index="{{ loop.index0 }}">
                                        <button type="button" class="status-btn" data-status="correct">
                                            âœ“ Correct
                                        </button>
                                        <button type="button" class="status-btn" data-status="wrong">
                                            âœ— Wrong
                                        </button>
                                        <button type="button" class="status-btn" data-status="unattempted">
                                            âˆ’ Skip
                                        </button>
                                    </div>
                                </div>
                                
                                <div class="col-md-6 mb-3">
                                    <label class="form-label" for="time_taken_{{ loop.index0 }}">Time (seconds)</label>
                                    <div class="input-group">
                                        <input 
                                            type="number" 
                                            class="form-control time-input" 
                                            id="time_taken_{{ loop.index0 }}"
                                            name="time_taken_{{ loop.index0 }}" 
                                            data-index="{{ loop.index0 }}"
                                            min="0"
                                            inputmode="numeric"
                                            pattern="[0-9]*"
                                        >
                                        <button 
                                            class="btn btn-outline-secondary disable-time-btn" 
                                            type="button"
                                            data-index="{{ loop.index0 }}"
                                            aria-label="Toggle time tracking"
                                            title="Disable time tracking"
                                        >
                                            ðŸš«
                                        </button>
                                    </div>
                                    <input 
                                        type="checkbox" 
                                        class="d-none disable-time-cb" 
                                        data-index="{{ loop.index0 }}"
                                    >
                                </div>
                            </div>
                        </div>
                    </fieldset>
                    {% endfor %}
                    
                    <hr role="separator" aria-label="PDF Generation Settings">
                    
                    <fieldset>
                        <legend class="h4">Generate PDF</legend>
                        <div class="row">
                            <div class="col-md-4 mb-3">
                                <label class="form-label" for="pdf_name">PDF Name</label>
                                <input 
                                    type="text" 
                                    id="pdf_name" 
                                    class="form-control" 
                                    value="My-Test-Analysis"
                                >
                            </div>
                            
                            <div class="col-md-4 mb-3">
                                <label class="form-label" for="images_per_page">Images per Page</label>
                                <select id="images_per_page" class="form-select">
                                    <option value="1">1</option>
                                    <option value="2">2</option>
                                    <option value="4" selected>4</option>
                                    <option value="6">6</option>
                                    <option value="8">8</option>
                                </select>
                            </div>
                            
                            <div class="col-md-4 mb-3">
                                <label class="form-label" for="filter_type">Filter Questions</label>
                                <select id="filter_type" class="form-select">
                                    <option value="all">All Questions</option>
                                    <option value="wrong">Wrong Only</option>
                                    <option value="unattempted">Unattempted Only</option>
                                </select>
                            </div>
                        </div>
                    </fieldset>
                    
                    <button 
                        type="submit" 
                        class="btn btn-primary w-100 mt-3 d-none d-md-block"
                        id="desktop-submit"
                    >
                        Generate PDF
                    </button>
                </form>
                
                <!-- Floating submit button for mobile -->
                <button 
                    type="button" 
                    class="btn btn-primary floating-submit d-md-none"
                    id="mobile-submit"
                    aria-label="Generate PDF"
                >
                    ðŸ“„ Generate
                </button>
                
                <div id="status" class="mt-3" role="status" aria-live="polite" aria-atomic="true"></div>
            </div>
        </div>
    </div>

<script>
    const numImages = {{ images|length }};
    const subjectInputs = document.querySelectorAll('.subject-input');
    let isMobile = window.innerWidth <= 768;
    let answerKeyData = new Map();

    window.addEventListener('resize', () => { isMobile = window.innerWidth <= 768; });

    function provideFeedback(message, type = 'info') {
        const announcement = document.createElement('div');
        announcement.setAttribute('aria-live', 'polite');
        announcement.className = 'sr-only';
        announcement.textContent = message;
        document.body.appendChild(announcement);
        setTimeout(() => document.body.removeChild(announcement), 1000);
        
        const toast = document.createElement('div');
        toast.className = `alert alert-${type} position-fixed`;
        toast.style.cssText = `top: 20px; left: 50%; transform: translateX(-50%); z-index: 9999; text-align: center; animation: slideDown 0.3s ease-out;`;
        toast.textContent = message;
        document.body.appendChild(toast);
        setTimeout(() => {
            toast.style.animation = 'slideUp 0.3s ease-out';
            setTimeout(() => document.body.removeChild(toast), 300);
        }, 2000);
    }

    const style = document.createElement('style');
    style.textContent = `@keyframes slideDown { from { transform: translateX(-50%) translateY(-100%); opacity: 0; } to { transform: translateX(-50%) translateY(0); opacity: 1; } } @keyframes slideUp { from { transform: translateX(-50%) translateY(0); opacity: 1; } to { transform: translateX(-50%) translateY(-100%); opacity: 0; } }`;
    document.head.appendChild(style);

    function handleJsonUpload(event) {
        const file = event.target.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = function(e) {
            try {
                const json = JSON.parse(e.target.result);
                if (!json.data || !Array.isArray(json.data)) throw new Error('Invalid JSON format.');
                answerKeyData.clear();
                json.data.forEach(item => {
                    if (item.question_number && item.answer) {
                        answerKeyData.set(String(item.question_number), String(item.answer));
                    }
                });
                provideFeedback(`Loaded ${answerKeyData.size} answers.`, 'success');
            } catch (error) {
                provideFeedback(`Error: ${error.message}`, 'danger');
            }
        };
        reader.readAsText(file);
    }

    document.querySelectorAll('input[id^="question_number_"]').forEach(input => {
        input.addEventListener('change', function() {
            const questionNumber = this.value;
            if (answerKeyData.has(questionNumber)) {
                const answer = answerKeyData.get(questionNumber);
                const index = this.id.split('_').pop();
                const correctAnswerInput = document.getElementById(`actual_solution_${index}`);
                if (correctAnswerInput) {
                    correctAnswerInput.value = answer;
                    provideFeedback(`Auto-filled Q#${questionNumber} with "${answer}".`, 'info');
                    correctAnswerInput.dispatchEvent(new Event('change'));
                }
            }
        });
    });

    document.getElementById('json-upload').addEventListener('change', handleJsonUpload);

    document.querySelectorAll('.status-buttons').forEach(group => {
        const buttons = group.querySelectorAll('.status-btn');
        const index = group.dataset.index;
        const hiddenSelect = document.getElementById(`status_${index}`);
        buttons.forEach(btn => {
            btn.addEventListener('click', function() {
                buttons.forEach(b => b.classList.remove('active'));
                this.classList.add('active');
                hiddenSelect.value = this.dataset.status;
            });
        });
        const initialBtn = group.querySelector(`[data-status='${hiddenSelect.value || 'correct'}']`);
        if(initialBtn) initialBtn.classList.add('active');
    });

    function getCurrentQuestionIndex() {
        const activeElement = document.activeElement;
        const parentFieldset = activeElement?.closest('fieldset[data-question-index]');
        return parentFieldset ? parseInt(parentFieldset.dataset.questionIndex, 10) : -1;
    }

    function setStatusForCurrentQuestion(status) {
        const currentIndex = getCurrentQuestionIndex();
        if (currentIndex !== -1) {
            document.querySelector(`.status-buttons[data-index='${currentIndex}'] .status-btn[data-status='${status}']`)?.click();
        } else {
            provideFeedback('Please select a question field first.', 'warning');
        }
    }

    function moveToNextQuestion() {
        let currentIndex = getCurrentQuestionIndex();
        const nextIndex = (currentIndex + 1) % numImages;
        const nextQuestionInput = document.getElementById(`question_number_${nextIndex}`);
        if (nextQuestionInput) {
            nextQuestionInput.focus();
            nextQuestionInput.scrollIntoView({ behavior: 'smooth', block: 'center' });
        }
    }

    document.addEventListener('keydown', function(e) {
        if (e.shiftKey) {
            const key = e.key.toLowerCase();
            if (['q', 'c', 'w', 'u'].includes(key)) e.preventDefault();
            switch(key) {
                case 'q': moveToNextQuestion(); break;
                case 'c': setStatusForCurrentQuestion('correct'); break;
                case 'w': setStatusForCurrentQuestion('wrong'); break;
                case 'u': setStatusForCurrentQuestion('unattempted'); break;
            }
        }
    });

    function validateForm() {
        let isValid = true;
        for (const field of document.querySelectorAll('input[required]')) {
            if (!field.value.trim()) {
                field.classList.add('is-invalid');
                if (isValid) {
                    field.focus();
                    provideFeedback('Please fill all required fields.', 'warning');
                }
                isValid = false;
            } else {
                field.classList.remove('is-invalid');
            }
        }
        return isValid;
    }

    document.getElementById('questions-form').addEventListener('submit', async function(e) {
        e.preventDefault();
        if (!validateForm()) return;

        const statusDiv = document.getElementById('status');
        const submitButtons = [document.getElementById('desktop-submit'), document.getElementById('mobile-submit')];
        
        submitButtons.forEach(btn => { if(btn) btn.disabled = true; });
        statusDiv.innerHTML = `<div class="alert alert-info">Generating PDF...</div>`;

        try {
            const questions = Array.from({ length: numImages }, (_, i) => ({
                question_number: document.getElementById(`question_number_${i}`).value,
                subject: document.getElementById(`subject_${i}`).value,
                status: document.getElementById(`status_${i}`).value,
                marked_solution: document.getElementById(`marked_solution_${i}`).value,
                actual_solution: document.getElementById(`actual_solution_${i}`).value,
                time_taken: document.querySelector(`.disable-time-cb[data-index='${i}']`).checked ? 'x' : document.getElementById(`time_taken_${i}`).value
            }));
            
            const sessionId = '{{ session_id }}';
            
            await fetch('/save_questions', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ session_id: sessionId, questions: questions })
            });

            const pdfResponse = await fetch('/generate_pdf', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    session_id: sessionId,
                    pdf_name: document.getElementById('pdf_name').value,
                    images_per_page: parseInt(document.getElementById('images_per_page').value, 10),
                    filter_type: document.getElementById('filter_type').value
                })
            });
            
            const result = await pdfResponse.json();
            
            if (result.error) throw new Error(result.error);
            
            statusDiv.innerHTML = `<div class="alert alert-success">PDF ready!</div><a href="/download/${result.pdf_filename}" class="btn btn-success w-100" download>Download PDF</a>`;
        } catch (error) {
            statusDiv.innerHTML = `<div class="alert alert-danger">Error: ${error.message}</div>`;
        } finally {
            submitButtons.forEach(btn => { if(btn) btn.disabled = false; });
        }
    });
</script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

</body>
</html>


