{% extends "base.html" %}

{% block title %}Enter Question Details (V2){% endblock %}

{% block head %}
<style>
    .keyboard-hint { font-size: 0.8em; color: #6c757d; margin-top: 2px; }
    .status-buttons { display: flex; gap: 0.25rem; margin-top: 0.25rem; }
    .status-btn { flex: 1; font-size: 0.75rem; padding: 0.25rem 0.5rem; border: 1px solid #495057; background: transparent; color: #fff; border-radius: 0.25rem; cursor: pointer; transition: all 0.2s; }
    .status-btn.active { background: #0d6efd; border-color: #0d6efd; }
    .status-btn:hover { background: #495057; }
    .auto-extract-btn { min-width: 120px; }
</style>
{% endblock %}

{% block content %}
<nav class="navbar navbar-expand-lg navbar-dark bg-dark">
    <div class="container-fluid">
        <a class="navbar-brand" href="/"><i class="bi bi-file-earmark-pdf-fill me-2"></i>DocuPDF</a>
        <div class="navbar-nav ms-auto">
            <a class="nav-link" href="/dashboard"><i class="bi bi-speedometer2 me-1"></i>Dashboard</a>
        </div>
    </div>
</nav>
<div class="container mt-3 mb-5">
    <div class="card bg-dark text-white">
        <div class="card-header d-flex justify-content-between align-items-center">
            <div>
                <h1 class="h3 mb-0">Step 3: Enter Question Details</h1>
                <div class="keyboard-hint">Shortcuts: Shift+Q for Next | Shift+C (Correct) | Shift+W (Wrong) | Shift+U (Unattempted)</div>
            </div>
            <a href="/cropv2/{{ session_id }}/0" class="btn btn-secondary"><i class="bi bi-arrow-left me-1"></i> Go Back to Cropping</a>
        </div>
        <div class="card-body">
            <fieldset class="mb-4">
                <legend class="h5">Upload Answer Key (Optional)</legend>
                <div class="mb-3">
                    <label for="json-upload" class="form-label">Upload a JSON file to auto-fill answers.</label>
                    <input class="form-control" type="file" id="json-upload" accept=".json">
                </div>
            </fieldset>

            <form id="questions-form">
                <fieldset class="mb-4">
                    <div class="form-check form-switch">
                        <input class="form-check-input" type="checkbox" id="same-subject-toggle">
                        <label class="form-check-label" for="same-subject-toggle">Same Subject for All</label>
                    </div>
                </fieldset>
                
                {% if not nvidia_nim_available %}
                <div class="alert alert-warning alert-dismissible fade show" role="alert">
                    <i class="bi bi-exclamation-triangle me-2"></i>
                    NVIDIA NIM OCR feature is not available. To enable automatic question number extraction, please set the <code>NVIDIA_API_KEY</code> environment variable.
                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                </div>
                {% else %}
                <div class="mb-3">
                    <button id="auto-extract-all" class="btn btn-primary">
                        <span class="spinner-border spinner-border-sm d-none" role="status" aria-hidden="true"></span>
                        <span class="extract-text">Auto Extract All Question Numbers</span>
                    </button>
                </div>
                {% endif %}

                {% for image in images %}
                <fieldset class="row mb-4 border-bottom pb-3" data-question-index="{{ loop.index0 }}" id="question-fieldset-{{ image.id }}">
                    <input type="hidden" name="image_id_{{ loop.index0 }}" value="{{ image.id }}">
                    <legend class="h5 col-12 mb-3">Question {{ loop.index }}
                        <button type="button" class="btn btn-sm btn-outline-danger float-end delete-question-btn" data-image-id="{{ image.id }}" data-index="{{ loop.index0 }}">
                            <i class="bi bi-trash"></i> Delete
                        </button>
                    </legend>
                    <div class="col-md-3 mb-3">
                        <img src="/image/processed/{{ image.processed_filename }}" class="img-fluid rounded" alt="Cropped Question {{ loop.index }}">
                    </div>
                    <div class="col-md-9">
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label" for="question_number_{{ loop.index0 }}">Question Number *</label>
                                {% if nvidia_nim_available %}
                                <div class="input-group">
                                    <input type="number" class="form-control" id="question_number_{{ loop.index0 }}" name="question_number_{{ loop.index0 }}" data-image-id="{{ image.id }}" required>
                                    <button class="btn btn-outline-secondary auto-extract-btn" type="button" data-image-id="{{ image.id }}" data-index="{{ loop.index0 }}">
                                        <span class="extract-spinner spinner-border spinner-border-sm d-none" role="status" aria-hidden="true"></span>
                                        <span class="extract-text">Auto Extract</span>
                                    </button>
                                </div>
                                {% else %}
                                <input type="number" class="form-control" id="question_number_{{ loop.index0 }}" name="question_number_{{ loop.index0 }}" data-image-id="{{ image.id }}" required>
                                {% endif %}
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label" for="subject_{{ loop.index0 }}">Subject</label>
                                <input type="text" class="form-control subject-input" id="subject_{{ loop.index0 }}" name="subject_{{ loop.index0 }}">
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label" for="marked_solution_{{ loop.index0 }}">Your Answer</label>
                                <input type="text" class="form-control" id="marked_solution_{{ loop.index0 }}" name="marked_solution_{{ loop.index0 }}">
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label" for="actual_solution_{{ loop.index0 }}">Correct Answer</label>
                                <input type="text" class="form-control" id="actual_solution_{{ loop.index0 }}" name="actual_solution_{{ loop.index0 }}">
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Status</label>
                                <select class="form-select d-none" id="status_{{ loop.index0 }}" name="status_{{ loop.index0 }}">
                                    <option value="correct">Correct</option>
                                    <option value="wrong">Wrong</option>
                                    <option value="unattempted" selected>Unattempted</option>
                                </select>
                                <div class="status-buttons" data-index="{{ loop.index0 }}">
                                    <button type="button" class="status-btn" data-status="correct">✓ Correct</button>
                                    <button type="button" class="status-btn" data-status="wrong">✗ Wrong</button>
                                    <button type="button" class="status-btn active" data-status="unattempted">− Skip</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </fieldset>
                {% endfor %}
                
                <fieldset>
                    <legend class="h4">Generate PDF</legend>
                    <div class="row">
                        <div class="col-md-4 mb-3"><label class="form-label" for="pdf_name">PDF Name</label><input type="text" id="pdf_name" class="form-control" value="My-Test-Analysis"></div>
                        <div class="col-md-4 mb-3"><label class="form-label" for="images_per_page">Images per Page</label><select id="images_per_page" class="form-select"><option value="4" selected>4</option><option value="6">6</option><option value="8">8</option></select></div>
                        <div class="col-md-4 mb-3"><label class="form-label" for="filter_type">Filter Questions</label><select id="filter_type" class="form-select"><option value="all">All</option><option value="wrong">Wrong Only</option><option value="unattempted">Unattempted Only</option></select></div>
                    </div>
                </fieldset>
                
                <button type="submit" class="btn btn-primary w-100 mt-3">Generate PDF</button>
            </form>
            <div id="status" class="mt-3"></div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    const numImages = {{ images|length }};
    const sessionId = '{{ session_id }}';
    let answerKeyData = new Map();

    function setupEventListeners() {
        document.getElementById('json-upload').addEventListener('change', handleJsonUpload);
        document.querySelectorAll('input[id^="question_number_"]').forEach(input => {
            input.addEventListener('change', handleQuestionNumberChange);
        });
        document.addEventListener('keydown', handleShortcuts);
        document.querySelectorAll('.status-buttons').forEach(setupStatusButtons);
        document.getElementById('questions-form').addEventListener('submit', handleFormSubmit);
        document.getElementById('same-subject-toggle').addEventListener('change', handleSameSubjectToggle);
        
        // Add event listeners for auto-extract buttons if NVIDIA NIM is available
        {% if nvidia_nim_available %}
        document.querySelectorAll('.auto-extract-btn').forEach(button => {
            button.addEventListener('click', function() {
                const imageId = this.dataset.imageId;
                const index = this.dataset.index;
                autoExtractQuestionNumber(this, imageId, index);
            });
        });
        
        // Add event listener for auto-extract all button
        document.getElementById('auto-extract-all').addEventListener('click', autoExtractAllQuestionNumbers);
        
        // Add event listeners for delete buttons
        document.querySelectorAll('.delete-question-btn').forEach(button => {
            button.addEventListener('click', function() {
                const imageId = this.dataset.imageId;
                const index = this.dataset.index;
                deleteQuestion(imageId, index);
            });
        });
        {% endif %}
    }

    function handleJsonUpload(event) {
        const file = event.target.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = (e) => {
            try {
                const json = JSON.parse(e.target.result);
                if (!json.data || !Array.isArray(json.data)) throw new Error('Invalid format');
                answerKeyData.clear();
                json.data.forEach(item => answerKeyData.set(String(item.question_number), String(item.answer)));
                showStatus(`Loaded ${answerKeyData.size} answers from key.`, 'success');
                // Auto-fill answers for existing question numbers
                document.querySelectorAll('input[id^="question_number_"]').forEach(input => {
                    if(input.value) handleQuestionNumberChange.call(input);
                });
            } catch (err) {
                showStatus('Error reading or parsing JSON file.', 'danger');
            }
        };
        reader.readAsText(file);
    }

    function handleQuestionNumberChange() {
        const qNum = this.value;
        if (answerKeyData.has(qNum)) {
            const index = this.id.split('_').pop();
            document.getElementById(`actual_solution_${index}`).value = answerKeyData.get(qNum);
        }
    }

    function handleSameSubjectToggle(e) {
        const subjectInputs = document.querySelectorAll('.subject-input');
        if (e.target.checked) {
            const firstSubject = subjectInputs[0].value;
            subjectInputs.forEach(input => input.value = firstSubject);
            subjectInputs[0].addEventListener('input', syncSubjects);
        } else {
            subjectInputs[0].removeEventListener('input', syncSubjects);
        }
    }

    function syncSubjects(e) {
        document.querySelectorAll('.subject-input').forEach(input => {
            input.value = e.target.value;
        });
    }

    function getCurrentQuestionIndex() {
        const activeElement = document.activeElement;
        const parentFieldset = activeElement?.closest('fieldset[data-question-index]');
        return parentFieldset ? parseInt(parentFieldset.dataset.questionIndex, 10) : -1;
    }

    function setStatusForCurrentQuestion(status) {
        const index = getCurrentQuestionIndex();
        if (index !== -1) {
            document.querySelector(`.status-buttons[data-index='${index}'] .status-btn[data-status='${status}']`)?.click();
        }
    }

    function moveToNextQuestion() {
        let index = getCurrentQuestionIndex();
        if (index === -1) index = 0;
        const nextIndex = (index + 1) % numImages;
        document.getElementById(`question_number_${nextIndex}`)?.focus();
    }

    function handleShortcuts(e) {
        if (e.shiftKey) {
            const key = e.key.toLowerCase();
            if (['q', 'c', 'w', 'u'].includes(key)) e.preventDefault();
            switch(key) {
                case 'q': moveToNextQuestion(); break;
                case 'c': setStatusForCurrentQuestion('correct'); break;
                case 'w': setStatusForCurrentQuestion('wrong'); break;
                case 'u': setStatusForCurrentQuestion('unattempted'); break;
            }
        }
    }

    function setupStatusButtons(group) {
        const buttons = group.querySelectorAll('.status-btn');
        const index = group.dataset.index;
        const select = document.getElementById(`status_${index}`);
        buttons.forEach(btn => {
            btn.addEventListener('click', () => {
                buttons.forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                select.value = btn.dataset.status;
            });
        });
    }

    async function handleFormSubmit(e) {
        e.preventDefault();
        const statusDiv = document.getElementById('status');
        showStatus('Saving questions and generating PDF...', 'info');
        
        const questions = [];
        document.querySelectorAll('fieldset[data-question-index]').forEach((fieldset, i) => {
            questions.push({
                image_id: fieldset.querySelector('input[name^="image_id_"]').value,
                question_number: fieldset.querySelector('input[name^="question_number_"]').value,
                subject: fieldset.querySelector('input[name^="subject_"]').value,
                status: fieldset.querySelector('select[name^="status_"]').value,
                marked_solution: fieldset.querySelector('input[name^="marked_solution_"]').value,
                actual_solution: fieldset.querySelector('input[name^="actual_solution_"]').value,
            });
        });

        try {
            // First, save the question data.
            const saveResponse = await fetch('/save_questions', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ session_id: sessionId, questions: questions })
            });
            if (!saveResponse.ok) throw new Error((await saveResponse.json()).error || 'Failed to save questions.');

            // Then, generate the PDF.
            const pdfResponse = await fetch('/generate_pdf', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    session_id: sessionId,
                    pdf_name: document.getElementById('pdf_name').value,
                    images_per_page: parseInt(document.getElementById('images_per_page').value, 10),
                    filter_type: document.getElementById('filter_type').value
                })
            });
            const result = await pdfResponse.json();
            if (result.error) throw new Error(result.error);
            
            statusDiv.innerHTML = `<a href="/download/${result.pdf_filename}" class="btn btn-success w-100">Download PDF: ${result.pdf_filename}</a>`;
        } catch (err) {
            showStatus(`Error: ${err.message}`, 'danger');
        }
    }

    function showStatus(message, type = 'info', duration = 4000) {
        const statusContainer = document.getElementById('status');
        const alertId = `alert-${Date.now()}`;
        const alert = `<div id="${alertId}" class="alert alert-${type} alert-dismissible fade show" role="alert">
            ${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>`;
        statusContainer.innerHTML = alert;
    }

    // Auto-extract question number function
    async function autoExtractQuestionNumber(button, imageId, index) {
        // Check if NVIDIA NIM is available
        {% if not nvidia_nim_available %}
        showStatus('NVIDIA NIM OCR feature is not available. Please set the NVIDIA_API_KEY environment variable.', 'warning');
        return;
        {% endif %}
        
        const spinner = button.querySelector('.extract-spinner');
        const text = button.querySelector('.extract-text');
        const questionInput = document.getElementById(`question_number_${index}`);
        
        // Show loading state
        spinner.classList.remove('d-none');
        text.classList.add('d-none');
        button.disabled = true;
        
        try {
            const response = await fetch('/extract_question_number', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ image_id: imageId })
            });
            
            const result = await response.json();
            
            if (result.success) {
                if (result.question_number) {
                    questionInput.value = result.question_number;
                    showStatus(`Question number ${result.question_number} extracted successfully!`, 'success');
                } else {
                    showStatus('No question number found in the image.', 'warning');
                }
            } else {
                showStatus(`Error: ${result.error}`, 'danger');
            }
        } catch (err) {
            showStatus(`Error extracting question number: ${err.message}`, 'danger');
        } finally {
            // Restore button state
            spinner.classList.add('d-none');
            text.classList.remove('d-none');
            button.disabled = false;
        }
    }

    // Auto-extract all question numbers function
    async function autoExtractAllQuestionNumbers() {
        // Check if NVIDIA NIM is available
        {% if not nvidia_nim_available %}
        showStatus('NVIDIA NIM OCR feature is not available. Please set the NVIDIA_API_KEY environment variable.', 'warning');
        return;
        {% endif %}
        
        const extractAllButton = document.getElementById('auto-extract-all');
        const extractAllSpinner = extractAllButton.querySelector('.spinner-border');
        const extractAllText = extractAllButton.querySelector('.extract-text');
        
        // Show loading state for the main button
        extractAllSpinner.classList.remove('d-none');
        extractAllText.textContent = 'Extracting...';
        extractAllButton.disabled = true;
        
        try {
            const response = await fetch('/extract_all_question_numbers', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ session_id: sessionId })
            });
            
            const result = await response.json();
            
            if (result.success) {
                // Process successful results
                result.results.forEach(item => {
                    if (item.question_number) {
                        // Find the correct input by using the data-image-id attribute
                        const questionInput = document.querySelector(`input[data-image-id="${item.image_id}"]`);
                        if (questionInput) {
                            questionInput.value = item.question_number;
                        }
                    }
                });
                
                // Show status message
                let message = `Successfully extracted ${result.results.length} question numbers.`;
                if (result.errors && result.errors.length > 0) {
                    message += ` Failed to extract ${result.errors.length} questions.`;
                }
                showStatus(message, 'success');
                
                // Show individual errors if any
                if (result.errors && result.errors.length > 0) {
                    result.errors.forEach(error => {
                        showStatus(`Error for image ${error.image_id}: ${error.error}`, 'danger');
                    });
                }
            } else {
                showStatus(`Error: ${result.error}`, 'danger');
            }
        } catch (err) {
            showStatus(`Error extracting question numbers: ${err.message}`, 'danger');
        } finally {
            // Restore button state
            extractAllSpinner.classList.add('d-none');
            extractAllText.textContent = 'Auto Extract All Question Numbers';
            extractAllButton.disabled = false;
        }
    }

    // Delete question function
    async function deleteQuestion(imageId, index) {
        if (!confirm('Are you sure you want to delete this question? This action cannot be undone.')) {
            return;
        }
        
        try {
            const response = await fetch(`/delete_question/${imageId}`, {
                method: 'DELETE'
            });
            
            const result = await response.json();
            
            if (result.success) {
                // Remove the fieldset from the DOM
                const fieldset = document.getElementById(`question-fieldset-${imageId}`);
                if (fieldset) {
                    fieldset.remove();
                }
                
                showStatus('Question deleted successfully!', 'success');
            } else {
                showStatus(`Error: ${result.error}`, 'danger');
            }
        } catch (err) {
            showStatus(`Error deleting question: ${err.message}`, 'danger');
        }
    }

    document.addEventListener('DOMContentLoaded', setupEventListeners);

</script>
{% endblock %}